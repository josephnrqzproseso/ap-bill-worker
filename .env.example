PORT=8080
LOG_LEVEL=info
WORKER_SHARED_SECRET=replace-me

# Runtime budget
RUN_BUDGET_MS=1500000
TIME_RESERVE_MS=25000

# Routing source
ROUTING_SOURCE=sheets
SHEETS_SPREADSHEET_ID=1yojv5SHHfhDCsCmXJx3Bpo7L7zIUes8JTmH3J_EQ8QY
ROUTING_SHEET_NAME=ProjectRouting
VENDOR_RULES_SHEET_NAME=VendorRules

# Scan controls
DOCS_BATCH_LIMIT=50
PASS1_UNRENAMED_LIMIT=50
PASS2_MARKED_LIMIT=50
SCAN_UNRENAMED_PREFIX=BILL
PROCESSED_MARKER_PREFIX=BILL_OCR_PROCESSED|V1|
OCR_JOB_MARKER_PREFIX=BILL_OCR_JOB|V1|
PDF_OCR_MAX_PAGES=80
OCR_MIN_TEXT_LEN=40
VISION_LANG_HINTS=en,fil

# Gemini
GEMINI_API_KEY=AIzaSyCbvHxTndbqGXfS1D710MrzcNdgu4MjFh0
GEMINI_MODEL=gemini-3-pro-preview

# Odoo defaults
SOURCE_BASE_URL=https://proseso-ventures.odoo.com
SOURCE_DB=proseso-ventures
SOURCE_LOGIN=joseph@proseso-consulting.com
SOURCE_PASSWORD=Papaya3562!
DEFAULT_EXPENSE_ACCOUNT_ID=

# GCS OCR staging and optional state storage
GCS_BUCKET=proseso-ap-ocr
GCS_INPUT_PREFIX=ap-ocr/input
GCS_OUTPUT_PREFIX=ap-ocr/output
STATE_BUCKET=
STATE_PREFIX=AP_BILL_STATE_V1



# ===== set these =====
$PROJECT_ID = "odoo-ocr-487104"
$REGION = "asia-southeast1"
$SERVICE = "ap-bill-ocr-worker"
$SHEET_ID = "1yojv5SHHfhDCsCmXJx3Bpo7L7zIUes8JTmH3J_EQ8QY"
$GCS_BUCKET = "<proseso-ap-ocr>"
$NEW_GEMINI_KEY = "AIzaSyCbvHxTndbqGXfS1D710MrzcNdgu4MjFh0"
# =====================

# 1) Set project
gcloud config set project $PROJECT_ID

# 2) Add new Gemini key version to Secret Manager
$NEW_GEMINI_KEY | gcloud secrets versions add gemini-api-key --data-file=- --project $PROJECT_ID

# 3) Redeploy Cloud Run (set env + secrets)
gcloud run deploy $SERVICE `
  --project $PROJECT_ID `
  --region $REGION `
  --image "asia-southeast1-docker.pkg.dev/$PROJECT_ID/ap-bill/ap-bill-ocr-worker:latest" `
  --service-account "ap-bill-worker@odoo-ocr-487104.iam.gserviceaccount.com" `
  --allow-unauthenticated `
  --port 8080 `
  --timeout 1800 `
  --set-env-vars "ROUTING_SOURCE=sheets,SHEETS_SPREADSHEET_ID=$SHEET_ID,GCS_BUCKET=$GCS_BUCKET,GEMINI_MODEL=gemini-2.5-pro" `
  --update-secrets "WORKER_SHARED_SECRET=worker-shared-secret:latest,GEMINI_API_KEY=gemini-api-key:latest"

# 4) Check health
$URL = gcloud run services describe $SERVICE --region $REGION --project $PROJECT_ID --format="value(status.url)"
$URL
Invoke-WebRequest "$URL/healthz" -UseBasicParsing

